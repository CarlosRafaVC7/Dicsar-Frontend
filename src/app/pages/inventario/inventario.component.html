<div class="inventario-shell">
  <!-- Encabezado -->
  <header class="panel-header">
    <div class="title-block">
      <h1>Gesti√≥n de Productos</h1>

    </div>

    <div class="controls">
      <input class="search" placeholder="Buscar producto o categor√≠a..." [(ngModel)]="search" />
      <select class="category-select" [(ngModel)]="selectedCategory" (change)="filtrarPorCategoria()">
        <option>Todas las categor√≠as</option>
        <option *ngFor="let c of categorias">{{ c.nombre }}</option>
      </select>

      <button class="btn-unidades" (click)="abrirModalUnidad()">Unidades de medida</button>

      <label class="btn-csv" title="Importar CSV">
        <input #inputCSV type="file" accept=".csv,text/csv" hidden (change)="importarCSV($event)" />
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
          <path d="M12 2v12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" />
          <path d="M5 13l7 7 7-7" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"
            stroke-linejoin="round" />
        </svg>
        Importar CSV
      </label>

      <!-- Bot√≥n Nuevo Producto -->
      <button class="btn btn-primario" (click)="abrirModalProducto()">+ Nuevo Producto</button>
    </div>
  </header>

  <!-- Tabs (se conservan) -->
  <div class="tabs tab-row">
    <button [class.active]="activeTab === 'productos'" (click)="cambiarTab('productos')">Productos</button>
    <button [class.active]="activeTab === 'categorias'" (click)="cambiarTab('categorias')">Categor√≠as</button>
    <button [class.active]="activeTab === 'unidades'" (click)="cambiarTab('unidades')">Unidades</button>
  </div>

  <!-- ========================== üõí TAB PRODUCTOS ========================== -->
  <div *ngIf="activeTab === 'productos'" class="tab-content">
    <!-- Productos: tabla moderna -->
    <section class="panel">
      <table class="products-table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Categor√≠a</th>
            <th>Unidad</th>
            <th>Precio</th>
            <th>Estado</th>
            <th class="actions-col">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of visibleProducts" class="product-row"
            [class.vencido]="esProductoVencido(p.fechaVencimiento)">
            <td class="name-col">
              <div class="cell-content">{{ p.nombre }}</div>
            </td>
            <td class="cat-col">
              <div class="cell-content">{{ p.categoria?.nombre || p.categoria }}</div>
            </td>
            <td class="unit-col">
              <div class="cell-content">{{ p.unidadMedida?.nombre || p.unidadMedida?.abreviatura || '-' }}</div>
            </td>

            <!-- Precio editable inline -->
            <td class="price-col">
              <div class="cell-content">
                <div *ngIf="editingPriceId !== p.idProducto; else editTpl" class="price-view">
                  <strong>{{ p.precioBase | currency:'USD':'symbol':'1.2-2' }}</strong>
                </div>
                <ng-template #editTpl>
                  <div class="price-edit">
                    <input type="number" step="0.01" [(ngModel)]="draftPrice" />
                  </div>
                </ng-template>
              </div>
            </td>
            <td>
              <span [ngClass]="{
      'badge-activo': p.estado === 'Activo',
      'badge-inactivo': p.estado === 'Inactivo'
    }">
                {{ p.estado }}
              </span>
            </td>
            <td class="actions actions-col">
              <!-- Mantener botones de edici√≥n inline de precio -->
              <div class="cell-content">
                <button *ngIf="editingPriceId !== p.idProducto" class="icon-btn" (click)="startEditPrice(p)"
                  title="Editar precio">üí≤</button>
                <button *ngIf="editingPriceId === p.idProducto" class="icon-btn confirm" (click)="confirmEditPrice(p)"
                  title="Confirmar">‚úÖ</button>
                <button *ngIf="editingPriceId === p.idProducto" class="icon-btn cancel" (click)="cancelEditPrice()"
                  title="Cancelar">‚ùå</button>

                <!-- Reemplazo: botones con texto claros y accesibles -->
                <button class="btn-action btn-edit" (click)="editarProducto(p)" title="Editar producto">Editar</button>
                <button class="btn-action btn-delete" (click)="eliminarProducto(p.idProducto)"
                  title="Eliminar producto">Eliminar</button>

              </div>
            </td>
          </tr>

          <tr *ngIf="visibleProducts.length === 0">
            <td colspan="5" class="empty">No hay productos que coincidan.</td>
          </tr>
        </tbody>
      </table>
    </section>

    <!-- Barra compacta en lugar del formulario grande -->
    <div class="compact-toolbar">
      <div class="left">
      </div>
      <div class="right">
        <!-- bot√≥n eliminado tal como solicitaste -->
      </div>
    </div>

    <!-- Modal: Nuevo Producto -->
    <div class="modal-overlay" *ngIf="mostrarModalProducto" (click)="cerrarModalProducto()">
      <div class="modal product-modal" (click)="$event.stopPropagation()">
        <header class="modal-head">
          <h3>{{ editandoProducto ? 'Editar Producto' : 'Nuevo Producto' }}</h3>
          <button class="close" (click)="cerrarModalProducto()">‚úñ</button>
        </header>

        <form class="product-modal-form" (ngSubmit)="guardarProducto()">
          <!-- Grid 2 columnas, labels compactos -->
          <div class="field">
            <label>Nombre</label>
            <input type="text" [(ngModel)]="nuevoProducto.nombre" name="modalNombre" required />
          </div>

          <div class="field">
            <label>C√≥digo</label>
            <input type="text" [(ngModel)]="nuevoProducto.codigo" name="modalCodigo" />
          </div>

          <div class="field">
            <label>Categor√≠a</label>
            <select [(ngModel)]="nuevoProducto.categoriaId" name="modalCategoria" required>
              <option [ngValue]="0">Seleccione...</option>
              <option *ngFor="let c of categorias" [ngValue]="c.idCategoria">{{ c.nombre }}</option>
            </select>
          </div>

          <div class="field">
            <label>Unidad</label>
            <select [(ngModel)]="nuevoProducto.unidadMedidaId" name="modalUnidad" required>
              <option [ngValue]="0">Seleccione...</option>
              <option *ngFor="let u of unidades" [ngValue]="u.idUnidadMed">{{ u.nombre }}</option>
            </select>
          </div>

          <div class="field full">
            <label>Descripci√≥n</label>
            <textarea [(ngModel)]="nuevoProducto.descripcion" name="modalDescripcion"></textarea>
          </div>

          <div class="field">
            <label>Precio</label>
            <input type="number" step="0.01" [(ngModel)]="nuevoProducto.precioBase" name="modalPrecio" />
          </div>

          <div class="field">
            <label>Stock Actual</label>
            <input type="number" [(ngModel)]="nuevoProducto.stockActual" name="modalStock" />
          </div>

          <div class="field">
            <label>Stock M√≠nimo</label>
            <input type="number" [(ngModel)]="nuevoProducto.stockMinimo" name="modalStockMin" />
          </div>

          <div class="field">
            <label>Proveedor</label>
            <select [(ngModel)]="nuevoProducto.proveedorId" name="modalProveedor">
              <option [ngValue]="null">Seleccione...</option>
              <option *ngFor="let p of proveedores" [ngValue]="p.idProveedor">{{ $any(p).nombre }}</option>
            </select>
          </div>

          <div class="field">
            <label>Fecha vencimiento</label>
            <input type="date" [(ngModel)]="nuevoProducto.fechaVencimiento" name="modalFecha" [min]="minDate" />
          </div>

          <footer class="modal-foot form-actions">
            <button type="button" class="btn btn-cancelar" (click)="cerrarModalProducto()">Cancelar</button>
            <button type="submit" class="btn btn-primario">{{ editandoProducto ? 'Actualizar' : 'Crear' }}</button>
          </footer>
        </form>
      </div>
    </div>
  </div>

  <!-- ========================== üìÇ TAB CATEGOR√çAS ========================== -->
  <div *ngIf="activeTab === 'categorias'" class="tab-content">
    <h2>Gesti√≥n de Categor√≠as</h2>
    <form (ngSubmit)="guardarCategoria()" class="formulario">
      <input type="text" placeholder="Nombre" [(ngModel)]="nuevaCategoria.nombre" name="nombre" required />
      <textarea placeholder="Descripci√≥n" [(ngModel)]="nuevaCategoria.descripcion" name="descripcion"></textarea>

      <button type="submit" class="btn btn-primario">
        {{ editandoCategoria ? 'Actualizar Categor√≠a' : 'Agregar Categor√≠a' }}
      </button>
      <button type="button" *ngIf="editandoCategoria" (click)="cancelarEdicionCategoria()" class="btn btn-cancelar">
        Cancelar
      </button>
    </form>

    <table class="tabla">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Descripci√≥n</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let c of categorias">
          <td>{{ c.nombre }}</td>
          <td>{{ c.descripcion }}</td>
          <td>
            <button class="btn-mini" (click)="editarCategoria(c)">‚úèÔ∏è</button>
            <button class="btn-mini eliminar" (click)="eliminarCategoria(c.idCategoria!)">üóëÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ========================== ‚öñÔ∏è TAB UNIDADES ========================== -->
  <div *ngIf="activeTab === 'unidades'" class="tab-content">
    <h2>Gesti√≥n de Unidades de Medida</h2>
    <form (ngSubmit)="guardarUnidad()" class="formulario">
      <input type="text" placeholder="Nombre" [(ngModel)]="nuevaUnidad.nombre" name="nombre" required />
      <input type="text" placeholder="Abreviatura" [(ngModel)]="nuevaUnidad.abreviatura" name="abreviatura" />

      <button type="submit" class="btn btn-primario">
        {{ editandoUnidad ? 'Actualizar Unidad' : 'Agregar Unidad' }}
      </button>
      <button type="button" *ngIf="editandoUnidad" (click)="cancelarEdicionUnidad()" class="btn btn-cancelar">
        Cancelar
      </button>
    </form>

    <table class="tabla">
      <thead>
        <tr>
          <th>Nombre</th>
          <th>Abreviatura</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let u of unidades">
          <td>{{ u.nombre }}</td>
          <td>{{ u.abreviatura }}</td>
          <td>
            <button class="btn-mini" (click)="editarUnidad(u)">‚úèÔ∏è</button>
            <button class="btn-mini eliminar" (click)="eliminarUnidad(u.idUnidadMed!)">üóëÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- ========================== ‚öôÔ∏è MODAL UNIDADES ========================== -->
  <div class="modal-overlay" *ngIf="mostrarModalUnidad" (click)="cerrarModalUnidad()">
    <div class="modal" (click)="$event.stopPropagation()">
      <header class="modal-head">
        <h3>Unidades de medida</h3>
        <button class="close" (click)="cerrarModalUnidad()">‚úñ</button>
      </header>
      <div class="modal-body">
        <ul class="units-list">
          <li *ngFor="let u of unidades">
            <span>{{ u.nombre }}</span>
            <small class="muted">{{ u.abreviatura }}</small>
          </li>
        </ul>
      </div>
      <footer class="modal-foot">
        <button class="btn" (click)="cerrarModalUnidad()">Cerrar</button>
      </footer>
    </div>
  </div>
</div>