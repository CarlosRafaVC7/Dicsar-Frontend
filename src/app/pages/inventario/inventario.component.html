<div class="inventario-shell">
  <!-- Encabezado principal -->
  <div class="module-header">
    <h1 class="module-title">M√≥dulo de Inventario</h1>
  </div>

  <!-- Tabs principales -->
  <div class="tabs-container">
    <div class="tabs">
      <button [class.active]="activeTab === 'productos'" (click)="cambiarTab('productos')" class="tab-button">
        üì¶ Productos
      </button>
      <button [class.active]="activeTab === 'reportes'" (click)="cambiarTab('reportes')" class="tab-button">
        üìä Reportes
      </button>
    </div>
  </div>

  <!-- ========================== üìä TAB REPORTES ========================== -->
  <div *ngIf="activeTab === 'reportes'" class="tab-content">
    <div class="reportes-grid">
      <div class="reporte-card">
        <div class="reporte-icon">üì¶</div>
        <div class="reporte-content">
          <h3>Total de Productos</h3>
          <div class="reporte-valor">{{ totalProductos }}</div>
          <p>Productos registrados en el sistema</p>
        </div>
      </div>

      <div class="reporte-card">
        <div class="reporte-icon">üí∞</div>
        <div class="reporte-content">
          <h3>Valor Total del Inventario</h3>
          <div class="reporte-valor">{{ valorTotalInventario | currency:'PEN':'S/ ':'1.2-2' }}</div>
          <p>Valor total basado en stock y precios actuales</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================== üõí TAB PRODUCTOS ========================== -->
  <div *ngIf="activeTab === 'productos'" class="tab-content">

    <!-- ‚ö†Ô∏è ALERTAS DE VENCIMIENTO -->
    <div class="alerta-vencimiento-section" *ngIf="productosVencidos.length > 0 || productosProximosAVencer.length > 0">
      <div class="alertas-container">
        <!-- Productos Vencidos -->
        <div class="alerta-vencido" *ngIf="productosVencidos.length > 0">
          <div class="alerta-header">
            <span class="alerta-icon">üö´</span>
            <span class="alerta-titulo">{{ productosVencidos.length }} Producto(s) Vencido(s)</span>
          </div>
          <div class="alerta-items">
            <div class="alerta-item" *ngFor="let p of productosVencidos">
              <strong>{{ p.nombre }}</strong> - Vencimiento: {{ p.fechaVencimiento | date:'dd/MM/yyyy' }}
            </div>
          </div>
        </div>

        <!-- Productos Pr√≥ximos a Vencer -->
        <div class="alerta-proximo" *ngIf="productosProximosAVencer.length > 0">
          <div class="alerta-header">
            <span class="alerta-icon">‚è∞</span>
            <span class="alerta-titulo">{{ productosProximosAVencer.length }} Producto(s) Pr√≥ximo(s) a Vencer</span>
          </div>
          <div class="alerta-items">
            <div class="alerta-item" *ngFor="let p of productosProximosAVencer">
              <strong>{{ p.nombre }}</strong> - Vence en {{ getDiasParaVencer(p.fechaVencimiento) }} d√≠as ({{
              p.fechaVencimiento | date:'dd/MM/yyyy' }})
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Controles superiores -->
    <div class="controls-panel">
      <!-- Estad√≠sticas de productos -->
      <div class="stats-row">
        <div class="stat-item active">
          <span class="stat-number">{{ productosActivos.length }}</span>
          <span class="stat-label">Activos</span>
        </div>
        <div class="stat-item inactive">
          <span class="stat-number">{{ productos.length - productosActivos.length }}</span>
          <span class="stat-label">Inactivos</span>
        </div>
        <div class="stat-item total">
          <span class="stat-number">{{ productos.length }}</span>
          <span class="stat-label">Total</span>
        </div>
      </div>

      <div class="controls-grid">
        <input class="search-input" placeholder="üîç Buscar producto, categor√≠a o c√≥digo..." [(ngModel)]="search" />

        <select class="category-select" [(ngModel)]="selectedCategory">
          <option>Todas las categor√≠as</option>
          <option *ngFor="let c of categorias">{{ c.nombre }}</option>
        </select>

        <button class="btn-secondary" (click)="abrirModalUnidad()">
          ‚öñÔ∏è Unidades
        </button>

        <button class="btn-secondary" (click)="abrirModalCategoria()">
          üìÇ Categor√≠as
        </button>

        <button class="btn-primary" (click)="abrirModalProducto()">
          ‚ûï Nuevo Producto
        </button>

        <button class="btn-export-pdf" (click)="exportarPDF()" title="Exportar a PDF">
          üìÑ PDF
        </button>

        <button class="btn-export-excel" (click)="exportarExcel()" title="Exportar a Excel">
          üìä Excel
        </button>
      </div>
    </div>

    <!-- Tabla de productos ORIGINAL CON COLORES Y BOTONES -->
    <div class="table-container">
      <table class="products-table">
        <thead>
          <tr>
            <th>Producto</th>
            <th>Categor√≠a</th>
            <th>Unidad</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of visibleProducts" [class.expired]="esProductoVencido(p.fechaVencimiento)"
            [class.low-stock]="p.stockActual <= p.stockMinimo" [class.inactive]="!p.estado">

            <!-- Columna Producto -->
            <td class="product-info">
              <div class="product-name">{{ p.nombre }}</div>
              <div class="product-code">{{ p.codigo }}</div>
              <div *ngIf="p.descripcion" class="product-desc">{{ p.descripcion }}</div>
              <div *ngIf="p.fechaVencimiento" class="expiry-date"
                [class.expired]="esProductoVencido(p.fechaVencimiento)">
                Vence: {{ p.fechaVencimiento | date:'dd/MM/yyyy' }}
              </div>
            </td>

            <!-- Columna Categor√≠a -->
            <td>
              <span class="category-badge">{{ p.categoria?.nombre || '-' }}</span>
            </td>

            <!-- Columna Unidad -->
            <td>
              <span class="unit-badge">{{ p.unidadMedida?.abreviatura || p.unidadMedida?.nombre || '-' }}</span>
            </td>

            <!-- Columna Precio CON BOT√ìN DE EDITAR -->
            <td class="price-cell">
              <div class="price-content">
                <strong>{{ p.precioBase | currency:'PEN':'S/ ':'1.2-2' }}</strong>
                <button class="btn-edit-price" (click)="abrirModalPrecio(p)" title="Editar precio">
                  ‚úèÔ∏è
                </button>
              </div>
            </td>

            <!-- Columna Stock -->
            <td class="stock-cell">
              <div [class]="p.stockActual <= p.stockMinimo ? 'stock-low' : 'stock-ok'">
                {{ p.stockActual }}
                <small>/ {{ p.stockMinimo }}</small>
              </div>
            </td>

            <!-- Columna Estado CON TOGGLE -->
            <td class="status-cell">
              <div class="status-toggle">
                <label class="toggle-switch">
                  <input type="checkbox" [checked]="p.estado" (change)="toggleEstadoProducto(p)">
                  <span class="slider"></span>
                </label>
                <span class="status-text" [class.active]="p.estado">
                  {{ p.estado ? 'Activo' : 'Inactivo' }}
                </span>
              </div>
            </td>

            <!-- Columna Acciones -->
            <td class="actions-cell">
              <div class="action-buttons">
                <button class="btn-edit" (click)="editarProducto(p)" title="Editar producto">
                  ‚úèÔ∏è Editar
                </button>
                <button class="btn-history" (click)="abrirHistorialPrecios(p)" title="Ver historial de precios (HU7)">
                  üìä Historial
                </button>
                <button class="btn-delete" (click)="eliminarProducto(p.idProducto)" title="Eliminar producto">
                  üóëÔ∏è Eliminar
                </button>
              </div>
            </td>
          </tr>

          <!-- Mensaje cuando no hay productos -->
          <tr *ngIf="visibleProducts.length === 0">
            <td colspan="7" class="no-data">
              <div class="no-data-content">
                <span>üì≠ No hay productos que coincidan con tu b√∫squeda</span>
              </div>
            </td>
          </tr>

          <!-- Mensaje informativo sobre productos inactivos -->
          <tr *ngIf="visibleProducts.length > 0 && (productos.length - productosActivos.length) > 0">
            <td colspan="7" class="inactive-info">
              <div class="inactive-info-content">
                <span>‚ÑπÔ∏è Los productos inactivos aparecen al final (son como eliminados suaves)</span>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ========================== üí∞ MODAL EDITAR PRECIO ========================== -->
  <div class="modal-overlay" *ngIf="mostrarModalPrecio" (click)="cerrarModalPrecio()">
    <div class="modal-content price-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üí∞ Cambiar Precio del Producto</h3>
        <button class="modal-close" (click)="cerrarModalPrecio()">√ó</button>
      </div>

      <div class="modal-body">
        <div class="price-form">
          <div class="product-info-card">
            <h4>Informaci√≥n del Producto</h4>
            <div class="info-grid">
              <div class="info-item">
                <label>Producto:</label>
                <span class="info-value">{{ productoEditandoPrecio?.nombre }}</span>
              </div>
              <div class="info-item">
                <label>C√≥digo:</label>
                <span class="info-value">{{ productoEditandoPrecio?.codigo }}</span>
              </div>
              <div class="info-item">
                <label>Precio Actual:</label>
                <span class="current-price">{{ productoEditandoPrecio?.precioBase | currency:'PEN':'S/ ':'1.2-2'
                  }}</span>
              </div>
            </div>
          </div>

          <div class="price-inputs">
            <div class="form-group">
              <label for="nuevoPrecio">Nuevo Precio *</label>
              <input type="number" id="nuevoPrecio" [(ngModel)]="nuevoPrecio" step="0.01" min="0.01" placeholder="0.00"
                class="price-input">
            </div>

            <div class="form-group">
              <label for="motivoCambio">Motivo del Cambio (Opcional)</label>
              <textarea id="motivoCambio" [(ngModel)]="motivoCambioPrecio"
                placeholder="Ej: Ajuste por inflaci√≥n, promoci√≥n, etc." rows="3" class="reason-textarea"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn-cancel" (click)="cerrarModalPrecio()">
          ‚ùå Cancelar
        </button>
        <button type="button" class="btn-primary" (click)="actualizarPrecio()">
          üí∞ Actualizar Precio
        </button>
      </div>
    </div>
  </div>

  <!-- Los otros modales (Unidades, Categor√≠as, Producto) se mantienen igual -->
  <!-- ========================== ‚öñÔ∏è MODAL UNIDADES ========================== -->
  <div class="modal-overlay" *ngIf="mostrarModalUnidad" (click)="cerrarModalUnidad()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>‚öñÔ∏è Gesti√≥n de Unidades de Medida</h3>
        <button class="modal-close" (click)="cerrarModalUnidad()">√ó</button>
      </div>

      <form class="modal-form" (ngSubmit)="guardarUnidad()">
        <div class="form-row">
          <div class="form-group">
            <label>Nombre *</label>
            <input type="text" [(ngModel)]="nuevaUnidad.nombre" name="nombre" required placeholder="Ej: Kilogramos">
          </div>
          <div class="form-group">
            <label>Abreviatura</label>
            <input type="text" [(ngModel)]="nuevaUnidad.abreviatura" name="abreviatura" placeholder="Ej: kg">
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">
            {{ editandoUnidad ? 'üîÑ Actualizar' : '‚ûï Agregar' }}
          </button>
          <button type="button" *ngIf="editandoUnidad" (click)="cancelarEdicionUnidad()" class="btn-cancel">
            ‚ùå Cancelar
          </button>
        </div>
      </form>

      <div class="modal-list">
        <h4>Unidades Existentes</h4>
        <div class="items-list">
          <div *ngFor="let u of unidades" class="item-card">
            <div class="item-info">
              <strong>{{ u.nombre }}</strong>
              <span class="item-desc">{{ u.abreviatura }}</span>
            </div>
            <div class="item-actions">
              <button class="btn-edit-small" (click)="editarUnidad(u)">‚úèÔ∏è</button>
              <button class="btn-delete-small" (click)="eliminarUnidad(u.idUnidadMed!)">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================== üìÇ MODAL CATEGOR√çAS ========================== -->
  <div class="modal-overlay" *ngIf="mostrarModalCategoria" (click)="cerrarModalCategoria()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>üìÇ Gesti√≥n de Categor√≠as</h3>
        <button class="modal-close" (click)="cerrarModalCategoria()">√ó</button>
      </div>

      <form class="modal-form" (ngSubmit)="guardarCategoria()">
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" [(ngModel)]="nuevaCategoria.nombre" name="nombre" required placeholder="Ej: Bebidas">
        </div>
        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea [(ngModel)]="nuevaCategoria.descripcion" name="descripcion"
            placeholder="Descripci√≥n de la categor√≠a"></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">
            {{ editandoCategoria ? 'üîÑ Actualizar' : '‚ûï Agregar' }}
          </button>
          <button type="button" *ngIf="editandoCategoria" (click)="cancelarEdicionCategoria()" class="btn-cancel">
            ‚ùå Cancelar
          </button>
        </div>
      </form>

      <div class="modal-list">
        <h4>Categor√≠as Existentes</h4>
        <div class="items-list">
          <div *ngFor="let c of categorias" class="item-card">
            <div class="item-info">
              <strong>{{ c.nombre }}</strong>
              <span class="item-desc">{{ c.descripcion }}</span>
            </div>
            <div class="item-actions">
              <button class="btn-edit-small" (click)="editarCategoria(c)">‚úèÔ∏è</button>
              <button class="btn-delete-small" (click)="eliminarCategoria(c.idCategoria!)">üóëÔ∏è</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========================== üõí MODAL PRODUCTO ========================== -->
  <div class="modal-overlay" *ngIf="mostrarModalProducto" (click)="cerrarModalProducto()">
    <div class="modal-content large-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>{{ editandoProducto ? '‚úèÔ∏è Editar Producto' : '‚ûï Nuevo Producto' }}</h3>
        <button class="modal-close" (click)="cerrarModalProducto()">√ó</button>
      </div>

      <form class="product-form" (ngSubmit)="guardarProducto()">
        <div class="form-grid">
          <div class="form-group">
            <label>Nombre del Producto *</label>
            <input type="text" [(ngModel)]="nuevoProducto.nombre" name="modalNombre" required
              placeholder="Ej: Aceite Cocinero 12L">
          </div>

          <div class="form-group">
            <label>C√≥digo</label>
            <input type="text" [(ngModel)]="nuevoProducto.codigo" name="modalCodigo" placeholder="Ej: ACE-12">
          </div>

          <div class="form-group">
            <label>Categor√≠a *</label>
            <select [(ngModel)]="nuevoProducto.categoriaId" name="modalCategoria" required>
              <option [ngValue]="0">Seleccione una categor√≠a...</option>
              <option *ngFor="let c of categorias" [ngValue]="c.idCategoria">
                {{ c.nombre }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Unidad de Medida *</label>
            <select [(ngModel)]="nuevoProducto.unidadMedidaId" name="modalUnidad" required>
              <option [ngValue]="0">Seleccione una unidad...</option>
              <option *ngFor="let u of unidades" [ngValue]="u.idUnidadMed">
                {{ u.nombre }} ({{ u.abreviatura }})
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Precio Base (S/)</label>
            <input type="number" step="0.01" [(ngModel)]="nuevoProducto.precioBase" name="modalPrecio"
              placeholder="0.00">
          </div>

          <div class="form-group">
            <label>Precio de Compra (S/)</label>
            <input type="number" step="0.01" [(ngModel)]="nuevoProducto.precioCompra" name="modalPrecioCompra"
              placeholder="0.00">
          </div>

          <div class="form-group">
            <label>Stock Actual</label>
            <input type="number" [(ngModel)]="nuevoProducto.stockActual" name="modalStock" placeholder="0">
          </div>

          <div class="form-group">
            <label>Stock M√≠nimo</label>
            <input type="number" [(ngModel)]="nuevoProducto.stockMinimo" name="modalStockMin" placeholder="0">
          </div>

          <div class="form-group">
            <label>Proveedor</label>
            <select [(ngModel)]="nuevoProducto.proveedorId" name="modalProveedor">
              <option [ngValue]="null">Seleccione un proveedor...</option>
              <option *ngFor="let p of proveedores" [ngValue]="p.idProveedor">
                {{ p.nombre }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label>Fecha de Vencimiento</label>
            <input type="date" [(ngModel)]="nuevoProducto.fechaVencimiento" name="modalFecha" [min]="minDate">
          </div>

          <div class="form-group">
            <label class="estado-label">
              <input type="checkbox" [(ngModel)]="nuevoProducto.estado" name="modalEstado" class="estado-checkbox">
              <span class="estado-text">Estado Activo</span>
            </label>
          </div>

          <div class="form-group full-width">
            <label>Descripci√≥n</label>
            <textarea [(ngModel)]="nuevoProducto.descripcion" name="modalDescripcion"
              placeholder="Descripci√≥n del producto..." rows="3"></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="cerrarModalProducto()">
            ‚ùå Cancelar
          </button>
          <button type="submit" class="btn-primary">
            {{ editandoProducto ? 'üîÑ Actualizar' : '‚ûï Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- ========================== üìä MODAL HISTORIAL DE PRECIOS (HU7) ========================== -->
  <div class="modal-overlay" *ngIf="mostrarModalHistorial" (click)="cerrarHistorialPrecios()">
    <div class="modal-content" (click)="$event.stopPropagation()" style="max-width: 800px;">
      <div class="modal-header">
        <h2>üìä Historial de Cambios de Precios</h2>
        <button class="btn-close" (click)="cerrarHistorialPrecios()">‚úï</button>
      </div>

      <div class="modal-body" *ngIf="productoSeleccionadoHistorial">
        <!-- Informaci√≥n del Producto -->
        <div class="historial-header">
          <div class="header-info">
            <h3>{{ productoSeleccionadoHistorial.nombre }}</h3>
            <p class="codigo">C√≥digo: {{ productoSeleccionadoHistorial.codigo }}</p>
          </div>
          <div class="header-stats">
            <div class="stat-box">
              <span class="stat-label">Total Cambios</span>
              <span class="stat-value">{{ totalCambiosPrecio }}</span>
            </div>
            <div class="stat-box">
              <span class="stat-label">Precio Actual</span>
              <span class="stat-value">S/ {{ productoSeleccionadoHistorial.precioBase | number:'1.2-2' }}</span>
            </div>
            <div class="stat-box">
              <span class="stat-label">Precio Promedio</span>
              <span class="stat-value">S/ {{ precioPromedio | number:'1.2-2' }}</span>
            </div>
          </div>
        </div>

        <!-- Listado de Cambios -->
        <div class="historial-content" *ngIf="!cargandoHistorial">
          <div *ngIf="historialPrecios.length > 0" class="historial-list">
            <div class="historial-item" *ngFor="let item of historialPrecios; let i = index">
              <div class="item-header">
                <div class="item-date">
                  üìÖ {{ item.fechaCambio | date:'dd/MM/yyyy HH:mm' }}
                </div>
                <div class="item-user">
                  üë§ {{ item.usuario || 'Sistema' }}
                </div>
              </div>

              <div class="item-prices">
                <div class="price-box anterior">
                  <label>Precio Anterior</label>
                  <span class="price">S/ {{ item.precioAnterior | number:'1.2-2' }}</span>
                </div>

                <div class="price-arrow">‚Üí</div>

                <div class="price-box nuevo">
                  <label>Precio Nuevo</label>
                  <span class="price">S/ {{ item.precioNuevo | number:'1.2-2' }}</span>
                </div>

                <div class="variacion-badge" [class]="obtenerClaseVariacion(calcularVariacion(item))">
                  <span *ngIf="calcularVariacion(item) > 0">
                    üìà +{{ calcularVariacion(item) | number:'1.2-2' }}%
                  </span>
                  <span *ngIf="calcularVariacion(item) < 0">
                    üìâ {{ calcularVariacion(item) | number:'1.2-2' }}%
                  </span>
                  <span *ngIf="calcularVariacion(item) === 0">
                    ‚û°Ô∏è 0%
                  </span>
                </div>
              </div>
            </div>
          </div>

          <div *ngIf="historialPrecios.length === 0" class="empty-state">
            <p>üì≠ No hay cambios de precio registrados para este producto</p>
          </div>
        </div>

        <!-- Loading -->
        <div *ngIf="cargandoHistorial" class="loading-state">
          <div class="spinner"></div>
          <p>Cargando historial...</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-primary" (click)="cerrarHistorialPrecios()">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Sistema de Alertas -->
  <div *ngIf="alertaVisible" class="alert" [class]="'alert-' + alertaTipo">
    <span class="alert-message">{{ alertaMensaje }}</span>
  </div>
</div>