<!-- âš ï¸ ALERTA -->
<div *ngIf="alertaVisible" class="alerta" [ngClass]="alertaTipo">
  {{ alertaMensaje }}
</div>

<div class="inventario-container">

  <!-- ğŸ§­ TABS -->
  <div class="tabs">
    <button
      [class.active]="activeTab === 'productos'"
      (click)="cambiarTab('productos')">
      ğŸ“¦ Productos
    </button>

    <button
      [class.active]="activeTab === 'categorias'"
      (click)="cambiarTab('categorias')">
      ğŸ—‚ï¸ CategorÃ­as
    </button>

    <button
      [class.active]="activeTab === 'unidades'"
      (click)="cambiarTab('unidades')">
      ğŸ“ Unidades de Medida
    </button>
  </div>

  <!-- =================================================================== -->
  <!-- ğŸ§± TAB: PRODUCTOS -->
  <!-- =================================================================== -->
  <div *ngIf="activeTab === 'productos'" class="tab-content">
    <h2>ğŸ“¦ GestiÃ³n de Productos</h2>

    <form (ngSubmit)="guardarProducto()" class="formulario">
      <div class="form-row">
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" [(ngModel)]="nuevoProducto.nombre" name="nombreProducto" required />
        </div>

        <div class="form-group">
          <label>CÃ³digo:</label>
          <input type="text" [(ngModel)]="nuevoProducto.codigo" name="codigo" />
        </div>
      </div>

      <div class="form-group">
        <label>DescripciÃ³n:</label>
        <textarea [(ngModel)]="nuevoProducto.descripcion" name="descripcion" rows="2"></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Precio Base:</label>
          <input type="number" [(ngModel)]="nuevoProducto.precioBase" name="precioBase" required step="0.01" />
        </div>

        <div class="form-group">
          <label>Precio Compra:</label>
          <input type="number" [(ngModel)]="nuevoProducto.precioCompra" name="precioCompra" step="0.01" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Stock Actual:</label>
          <input type="number" [(ngModel)]="nuevoProducto.stockActual" name="stockActual" />
        </div>

        <div class="form-group">
          <label>Stock MÃ­nimo:</label>
          <input type="number" [(ngModel)]="nuevoProducto.stockMinimo" name="stockMinimo" />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>CategorÃ­a:</label>
          <select [(ngModel)]="nuevoProducto.categoriaId" name="categoriaId" required>
            <option value="">Seleccione categorÃ­a</option>
            <option *ngFor="let c of categorias" [value]="c.idCategoria">{{ c.nombre }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>Unidad de Medida:</label>
          <select [(ngModel)]="nuevoProducto.unidadMedidaId" name="unidadMedidaId" required>
            <option value="">Seleccione unidad</option>
            <option *ngFor="let u of unidades" [value]="u.idUnidadMed">{{ u.nombre }}</option>
          </select>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label>Proveedor:</label>
          <select [(ngModel)]="nuevoProducto.proveedorId" name="proveedorId">
            <option [ngValue]="null">Sin proveedor</option>
            <option *ngFor="let p of proveedores" [value]="p.idProveedor">{{ p.razonSocial }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>Fecha de Vencimiento:</label>
          <input 
            type="date" 
            [(ngModel)]="nuevoProducto.fechaVencimiento" 
            name="fechaVencimiento" 
            [min]="minDate" />
        </div>
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn-guardar">
          {{ editandoProducto ? 'ğŸ”„ Actualizar' : 'ğŸ’¾ Guardar' }}
        </button>
        <button *ngIf="editandoProducto" type="button" (click)="cancelarEdicionProducto()" class="btn-cancelar">
          âŒ Cancelar
        </button>
      </div>
    </form>

    <div class="tabla-container">
      <table class="tabla">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>CÃ³digo</th>
            <th>Precio</th>
            <th>Stock</th>
            <th>CategorÃ­a</th>
            <th>Unidad</th>
            <th>Proveedor</th>
            <th>Vencimiento</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of productos">
            <td>{{ p.idProducto }}</td>
            <td>{{ p.nombre }}</td>
            <td>{{ p.codigo }}</td>
            <td class="precio">S/ {{ p.precioBase | number:'1.2-2' }}</td>
            <td [class.stock-bajo]="p.stockActual <= p.stockMinimo" class="stock">
              {{ p.stockActual }}
            </td>
            <!-- ğŸ”¥ SOLUCIÃ“N: Usar el objeto categorÃ­a completo del backend -->
            <td>{{ p.categoria?.nombre || '---' }}</td>
            <td>{{ p.unidadMedida?.nombre || '---' }}</td>
            <td>{{ p.proveedor?.razonSocial || '---' }}</td>
            <td [class.vencido]="esProductoVencido(p.fechaVencimiento)" class="fecha">
              {{ p.fechaVencimiento | date:'dd/MM/yyyy' }}
            </td>
            <td class="acciones">
              <button (click)="editarProducto(p)" class="btn-editar" title="Editar">âœï¸</button>
              <button (click)="eliminarProducto(p.idProducto!)" class="btn-eliminar" title="Eliminar">ğŸ—‘ï¸</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- =================================================================== -->
  <!-- ğŸŸ¦ TAB: CATEGORÃAS -->
  <!-- =================================================================== -->
  <div *ngIf="activeTab === 'categorias'" class="tab-content">
    <h2>ğŸ—‚ï¸ GestiÃ³n de CategorÃ­as</h2>

    <!-- Formulario -->
    <form (ngSubmit)="guardarCategoria()" class="formulario">
      <div class="form-row">
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" [(ngModel)]="nuevaCategoria.nombre" name="nombreCategoria" required />
        </div>

        <div class="form-group">
          <label>DescripciÃ³n:</label>
          <input type="text" [(ngModel)]="nuevaCategoria.descripcion" name="descripcionCategoria" />
        </div>
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn-guardar">
          {{ editandoCategoria ? 'ğŸ”„ Actualizar' : 'ğŸ’¾ Guardar' }}
        </button>
        <button *ngIf="editandoCategoria" type="button" (click)="cancelarEdicionCategoria()" class="btn-cancelar">
          âŒ Cancelar
        </button>
      </div>
    </form>

    <!-- Tabla -->
    <div class="tabla-container">
      <table class="tabla">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>DescripciÃ³n</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of categorias">
            <td>{{ c.idCategoria }}</td>
            <td>{{ c.nombre }}</td>
            <td>{{ c.descripcion }}</td>
            <td>
              <span [class.estado-activo]="c.estado" [class.estado-inactivo]="!c.estado" class="estado">
                {{ c.estado ? 'âœ… Activo' : 'âŒ Inactivo' }}
              </span>
            </td>
            <td class="acciones">
              <button (click)="editarCategoria(c)" class="btn-editar" title="Editar">âœï¸</button>
              <button (click)="eliminarCategoria(c.idCategoria!)" class="btn-eliminar" title="Eliminar">ğŸ—‘ï¸</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- =================================================================== -->
  <!-- ğŸŸ© TAB: UNIDADES DE MEDIDA -->
  <!-- =================================================================== -->
  <div *ngIf="activeTab === 'unidades'" class="tab-content">
    <h2>ğŸ“ GestiÃ³n de Unidades de Medida</h2>

    <!-- Formulario -->
    <form (ngSubmit)="guardarUnidad()" class="formulario">
      <div class="form-row">
        <div class="form-group">
          <label>Nombre:</label>
          <input type="text" [(ngModel)]="nuevaUnidad.nombre" name="nombreUnidad" required />
        </div>

        <div class="form-group">
          <label>Abreviatura:</label>
          <input type="text" [(ngModel)]="nuevaUnidad.abreviatura" name="abreviaturaUnidad" required maxlength="5" />
        </div>
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn-guardar">
          {{ editandoUnidad ? 'ğŸ”„ Actualizar' : 'ğŸ’¾ Guardar' }}
        </button>
        <button *ngIf="editandoUnidad" type="button" (click)="cancelarEdicionUnidad()" class="btn-cancelar">
          âŒ Cancelar
        </button>
      </div>
    </form>

    <!-- Tabla -->
    <div class="tabla-container">
      <table class="tabla">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Abreviatura</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let u of unidades">
            <td>{{ u.idUnidadMed }}</td>
            <td>{{ u.nombre }}</td>
            <td><span class="abreviatura">{{ u.abreviatura }}</span></td>
            <td>
              <span [class.estado-activo]="u.estado" [class.estado-inactivo]="!u.estado" class="estado">
                {{ u.estado ? 'âœ… Activo' : 'âŒ Inactivo' }}
              </span>
            </td>
            <td class="acciones">
              <button (click)="editarUnidad(u)" class="btn-editar" title="Editar">âœï¸</button>
              <button (click)="eliminarUnidad(u.idUnidadMed!)" class="btn-eliminar" title="Eliminar">ğŸ—‘ï¸</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

</div>