<div class="proveedores-shell">
  <!-- Mensajes de alerta -->
  <div class="alert" *ngIf="alertaVisible" [ngClass]="'alert-' + alertaTipo">
    <span>{{ alertaMensaje }}</span>
    <button class="alert-close" (click)="alertaVisible = false">&times;</button>
  </div>

  <!-- Encabezado del m√≥dulo -->
  <div class="module-header">
    <h1>üì¶ M√≥dulo de Proveedores</h1>
    <p>Gestiona tus proveedores y consulta su informaci√≥n</p>
  </div>

  <!-- Sistema de Tabs -->
  <div class="tabs-container">
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'proveedores'"
      (click)="cambiarTab('proveedores')">
      üìã Proveedores
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'productos-proveedor'"
      (click)="cambiarTab('productos-proveedor')">
      üì¶ Productos por Proveedor
    </button>
    <button 
      class="tab-button" 
      [class.active]="activeTab === 'reportes'"
      (click)="cambiarTab('reportes')">
      üìä Reportes
    </button>
  </div>

  <!-- Tab 1: Proveedores -->
  <div *ngIf="activeTab === 'proveedores'" class="tab-content">
    <!-- Estad√≠sticas -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon">üì¶</div>
        <div class="stat-info">
          <h3>Total Proveedores</h3>
          <p class="stat-value">{{ proveedores.length }}</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-info">
          <h3>Proveedores Activos</h3>
          <p class="stat-value">{{ proveedoresActivos }}</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚ùå</div>
        <div class="stat-info">
          <h3>Proveedores Inactivos</h3>
          <p class="stat-value">{{ proveedores.length - proveedoresActivos }}</p>
        </div>
      </div>
    </div>

    <!-- Controles de b√∫squeda y filtros -->
    <div class="controls-grid">
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input 
          type="text" 
          [(ngModel)]="busqueda" 
          (input)="onBuscar()"
          placeholder="Buscar por raz√≥n social o RUC..." 
          class="search-input">
      </div>
      
      <div class="filter-group">
        <select [(ngModel)]="filtroEstado" (change)="onBuscar()" class="filter-select">
          <option value="todos">Todos los estados</option>
          <option value="activos">Solo Activos</option>
          <option value="inactivos">Solo Inactivos</option>
        </select>
      </div>

      <button class="btn-primary" (click)="abrirModalProveedor()">
        ‚ûï Nuevo Proveedor
      </button>

      <button class="btn-export" (click)="exportarProveedoresPDF()">
        üìÑ PDF
      </button>

      <button class="btn-export" (click)="exportarProveedoresExcel()">
        üìä Excel
      </button>
    </div>

    <!-- Tabla de proveedores -->
    <div class="table-container">
      <table class="products-table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Raz√≥n Social</th>
            <th>RUC</th>
            <th>Tel√©fono</th>
            <th>Email</th>
            <th>Direcci√≥n</th>
            <th>Contacto</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of proveedoresVisibles">
            <td>{{ p.idProveedor }}</td>
            <td class="product-name">{{ p.razonSocial }}</td>
            <td>{{ p.ruc }}</td>
            <td>{{ p.telefono }}</td>
            <td>{{ p.email }}</td>
            <td>{{ p.direccion }}</td>
            <td>{{ p.contacto || 'N/A' }}</td>
            <td class="status-cell">
              <div class="status-toggle">
                <label class="toggle-switch">
                  <input 
                    type="checkbox" 
                    [checked]="p.estado"
                    (change)="toggleEstadoProveedor(p)">
                  <span class="slider"></span>
                </label>
                <span class="status-text" [class.active]="p.estado">
                  {{ p.estado ? 'Activo' : 'Inactivo' }}
                </span>
              </div>
            </td>
            <td class="actions-cell">
              <button 
                class="btn-edit" 
                (click)="editarProveedor(p)"
                title="Editar">
                ‚úèÔ∏è
              </button>
              <button 
                class="btn-delete" 
                (click)="eliminarProveedor(p.idProveedor)"
                title="Eliminar">
                üóëÔ∏è
              </button>
            </td>
          </tr>
          <tr *ngIf="proveedoresVisibles.length === 0">
            <td colspan="9" class="no-data">No se encontraron proveedores</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginaci√≥n -->
    <div class="pagination" *ngIf="totalPaginasProveedores > 1">
      <button 
        class="page-btn" 
        (click)="cambiarPaginaProveedores(paginaActualProveedores - 1)" 
        [disabled]="paginaActualProveedores === 1">
        ‚Üê Anterior
      </button>
      <span class="page-info">P√°gina {{ paginaActualProveedores }} de {{ totalPaginasProveedores }}</span>
      <button 
        class="page-btn" 
        (click)="cambiarPaginaProveedores(paginaActualProveedores + 1)" 
        [disabled]="paginaActualProveedores === totalPaginasProveedores">
        Siguiente ‚Üí
      </button>
    </div>
  </div>

  <!-- Tab 2: Productos por Proveedor -->
  <div *ngIf="activeTab === 'productos-proveedor'" class="tab-content">
    <div class="productos-proveedor-container">
      <!-- Panel izquierdo: Lista de proveedores -->
      <div class="proveedores-list-panel">
        <h2>Seleccionar Proveedor</h2>
        <div class="search-box">
          <input 
            type="text" 
            [(ngModel)]="busquedaProveedor"
            (input)="filtrarProveedores()"
            placeholder="Buscar proveedor..." 
            class="search-input">
          <span class="search-icon">üîç</span>
        </div>
        <div class="proveedores-list">
          <div 
            *ngFor="let p of proveedoresFiltrados"
            class="proveedor-item"
            [class.selected]="proveedorSeleccionado?.idProveedor === p.idProveedor"
            (click)="seleccionarProveedor(p)">
            <h4>{{ p.razonSocial }}</h4>
            <p>RUC: {{ p.ruc }}</p>
            <span class="badge" [class.badge-active]="p.estado" [class.badge-inactive]="!p.estado">
              {{ p.estado ? 'Activo' : 'Inactivo' }}
            </span>
          </div>
          <div *ngIf="proveedoresFiltrados.length === 0" class="no-data">
            No hay proveedores disponibles
          </div>
        </div>
      </div>

      <!-- Panel derecho: Productos del proveedor seleccionado -->
      <div class="productos-panel">
        <div *ngIf="!proveedorSeleccionado" class="empty-state">
          <div class="empty-icon">üì¶</div>
          <h3>Selecciona un proveedor</h3>
          <p>Selecciona un proveedor de la lista para ver sus productos</p>
        </div>

        <div *ngIf="proveedorSeleccionado" class="productos-content">
          <div class="panel-header">
            <h2>Productos de {{ proveedorSeleccionado.razonSocial }}</h2>
            <div class="proveedor-info">
              <span><strong>RUC:</strong> {{ proveedorSeleccionado.ruc }}</span>
              <span><strong>Tel√©fono:</strong> {{ proveedorSeleccionado.telefono }}</span>
              <span><strong>Email:</strong> {{ proveedorSeleccionado.email }}</span>
            </div>
          </div>

          <div class="productos-stats">
            <div class="stat-mini">
              <span class="stat-label">Total Productos:</span>
              <span class="stat-value">{{ productosProveedor.length }}</span>
            </div>
            <div class="stat-mini">
              <span class="stat-label">Productos Activos:</span>
              <span class="stat-value">{{ productosProveedorActivos }}</span>
            </div>
          </div>

          <div class="table-container">
            <table class="products-table">
              <thead>
                <tr>
                  <th>C√≥digo</th>
                  <th>Nombre</th>
                  <th>Categor√≠a</th>
                  <th>Precio Base</th>
                  <th>Stock</th>
                  <th>Estado</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let producto of productosProveedor">
                  <td>{{ producto.codigo }}</td>
                  <td class="product-name">{{ producto.nombre }}</td>
                  <td>{{ producto.categoria }}</td>
                  <td>{{ producto.precioBase | currency:'PEN':'S/ ':'1.2-2' }}</td>
                  <td>
                    <span 
                      class="stock-badge"
                      [class.stock-low]="producto.stockActual <= producto.stockMinimo"
                      [class.stock-normal]="producto.stockActual > producto.stockMinimo">
                      {{ producto.stockActual }} {{ producto.unidadMedida }}
                    </span>
                  </td>
                  <td>
                    <span [class]="producto.estado ? 'status-active' : 'status-inactive'">
                      {{ producto.estado ? 'Activo' : 'Inactivo' }}
                    </span>
                  </td>
                </tr>
                <tr *ngIf="productosProveedor.length === 0">
                  <td colspan="6" class="no-data">
                    Este proveedor no tiene productos registrados
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tab 3: Reportes -->
  <div *ngIf="activeTab === 'reportes'" class="tab-content">
    <div class="reportes-section">
      <!-- Barra de acciones -->
      <div class="reportes-actions">
        <div class="reportes-title">
          <h2>üìä Estad√≠sticas de Proveedores</h2>
          <p>An√°lisis y m√©tricas del m√≥dulo</p>
        </div>
        <div class="export-buttons">
          <button class="btn-export excel" (click)="exportarReporteProveedoresExcel()">
            <span class="btn-icon">üìä</span>
            Excel
          </button>
          <button class="btn-export pdf" (click)="exportarReporteProveedoresPDF()">
            <span class="btn-icon">üìÑ</span>
            PDF
          </button>
        </div>
      </div>

      <!-- Tarjetas de estad√≠sticas -->
      <div class="reportes-grid" *ngIf="reporteProveedores">
        <div class="reporte-card stat-total">
          <div class="reporte-icon">üì¶</div>
          <div class="reporte-content">
            <h3>Total Proveedores</h3>
            <div class="reporte-valor">{{ reporteProveedores.totalProveedores }}</div>
            <p>Proveedores registrados</p>
          </div>
        </div>

        <div class="reporte-card stat-activo">
          <div class="reporte-icon">‚úÖ</div>
          <div class="reporte-content">
            <h3>Proveedores Activos</h3>
            <div class="reporte-valor">{{ reporteProveedores.proveedoresActivos }}</div>
            <p>Con estado activo ({{ calcularPorcentaje(reporteProveedores.proveedoresActivos, reporteProveedores.totalProveedores) }}%)</p>
          </div>
        </div>

        <div class="reporte-card stat-inactivo">
          <div class="reporte-icon">‚ùå</div>
          <div class="reporte-content">
            <h3>Proveedores Inactivos</h3>
            <div class="reporte-valor">{{ reporteProveedores.totalProveedores - reporteProveedores.proveedoresActivos }}</div>
            <p>Con estado inactivo</p>
          </div>
        </div>

        <div class="reporte-card stat-promedio">
          <div class="reporte-icon">ÔøΩ</div>
          <div class="reporte-content">
            <h3>Promedio Productos</h3>
            <div class="reporte-valor">{{ calcularPromedioProductos() }}</div>
            <p>Productos por proveedor</p>
          </div>
        </div>
      </div>

      <!-- Proveedor destacado -->
      <div class="proveedor-destacado" *ngIf="reporteProveedores?.proveedorConMasProductos">
        <div class="destacado-header">
          <span class="destacado-icon">üìà</span>
          <h3>Proveedor con M√°s Productos</h3>
        </div>
        <div class="destacado-content">
          <div class="destacado-info">
            <h4>{{ reporteProveedores.proveedorConMasProductos.razonSocial }}</h4>
            <p class="destacado-ruc">RUC: {{ reporteProveedores.proveedorConMasProductos.ruc }}</p>
          </div>
          <div class="destacado-cantidad">
            <div class="cantidad-numero">{{ reporteProveedores.proveedorConMasProductos.cantidadProductos }}</div>
            <div class="cantidad-texto">productos</div>
          </div>
        </div>
      </div>

      <!-- Gr√°ficos Estad√≠sticos -->
      <div class="charts-section" *ngIf="reporteProveedores">
        <h2>üìä An√°lisis Visual</h2>
        <div class="charts-grid">
          <!-- Gr√°fico de distribuci√≥n de proveedores -->
          <div class="chart-card">
            <h3>Distribuci√≥n de Proveedores</h3>
            <p class="chart-subtitle">Activos vs Inactivos</p>
            <div class="chart-container">
              <canvas #chartProveedores></canvas>
            </div>
            <div class="chart-legend">
              <div class="legend-item">
                <span class="legend-color activo"></span>
                <span>Activos: {{ reporteProveedores.proveedoresActivos }} ({{ calcularPorcentaje(reporteProveedores.proveedoresActivos, reporteProveedores.totalProveedores) }}%)</span>
              </div>
              <div class="legend-item">
                <span class="legend-color inactivo"></span>
                <span>Inactivos: {{ reporteProveedores.totalProveedores - reporteProveedores.proveedoresActivos }} ({{ calcularPorcentaje(reporteProveedores.totalProveedores - reporteProveedores.proveedoresActivos, reporteProveedores.totalProveedores) }}%)</span>
              </div>
            </div>
          </div>

          <!-- Gr√°fico de productos por proveedor -->
          <div class="chart-card">
            <h3>Productos por Proveedor</h3>
            <p class="chart-subtitle">Cantidad de productos por proveedor</p>
            <div class="chart-container">
              <canvas #chartProductos></canvas>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="!reporteProveedores" class="loading-state">
        <div class="spinner"></div>
        <p>Cargando reportes...</p>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Crear/Editar Proveedor -->
<div class="modal-overlay" *ngIf="mostrarModalProveedor" (click)="cerrarModalProveedor()">
  <div class="modal-content proveedor-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editandoProveedor ? '‚úèÔ∏è Editar Proveedor' : '‚ûï Nuevo Proveedor' }}</h3>
      <button class="modal-close" (click)="cerrarModalProveedor()">&times;</button>
    </div>
    
    <div class="modal-body">
      <form [formGroup]="proveedorForm" (ngSubmit)="guardarProveedor()">
        <div class="form-row">
          <div class="form-group full-width">
            <label for="razonSocial">Raz√≥n Social *</label>
            <input 
              type="text" 
              id="razonSocial" 
              formControlName="razonSocial"
              class="form-control"
              [class.is-invalid]="esInvalido('razonSocial')"
              placeholder="Ingrese la raz√≥n social">
            <div class="invalid-feedback" *ngIf="esInvalido('razonSocial')">
              {{ obtenerMensajeError('razonSocial') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="ruc">RUC *</label>
            <input 
              type="text" 
              id="ruc" 
              formControlName="ruc"
              class="form-control"
              [class.is-invalid]="esInvalido('ruc')"
              placeholder="10/15/16/17/20 + 9 d√≠gitos"
              maxlength="11">
            <div class="invalid-feedback" *ngIf="esInvalido('ruc')">
              {{ obtenerMensajeError('ruc') }}
            </div>
          </div>

          <div class="form-group">
            <label for="telefono">Tel√©fono *</label>
            <input 
              type="text" 
              id="telefono" 
              formControlName="telefono"
              class="form-control"
              [class.is-invalid]="esInvalido('telefono')"
              placeholder="N√∫mero de tel√©fono">
            <div class="invalid-feedback" *ngIf="esInvalido('telefono')">
              {{ obtenerMensajeError('telefono') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="email">Email *</label>
            <input 
              type="email" 
              id="email" 
              formControlName="email"
              class="form-control"
              [class.is-invalid]="esInvalido('email')"
              placeholder="correo@ejemplo.com">
            <div class="invalid-feedback" *ngIf="esInvalido('email')">
              {{ obtenerMensajeError('email') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="direccion">Direcci√≥n *</label>
            <textarea 
              id="direccion" 
              formControlName="direccion"
              class="form-control"
              [class.is-invalid]="esInvalido('direccion')"
              placeholder="Direcci√≥n completa"
              rows="2"></textarea>
            <div class="invalid-feedback" *ngIf="esInvalido('direccion')">
              {{ obtenerMensajeError('direccion') }}
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group full-width">
            <label for="contacto">Persona de Contacto</label>
            <input 
              type="text" 
              id="contacto" 
              formControlName="contacto"
              class="form-control"
              placeholder="Nombre del contacto (opcional)">
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn-secondary" (click)="cerrarModalProveedor()">
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="proveedorForm.invalid">
            {{ editandoProveedor ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>